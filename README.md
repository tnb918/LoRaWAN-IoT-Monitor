# LoRaWAN-IoT-Monitor
## IoT environmental monitoring system based on LoRaWAN and STM32L4

## 基础设计实现功能

1、设备参数配置：终端和云端的设备类型均为Class A，终端上行数据为确认帧。

2、终端入网：控制终端完成入网，入网超时时间120s。 

3、数据数据采集、处理和优化：

    （1）应用层按照3s/次的速率获取终端传感数值，数据保存在MCU中。

    （2）应用层采集10次传感数值，进行数据处理，数据处理完成后按照数据通信协议（表1）上传至云平台
        （数据通信协议上传格式为16进制，非字符串形式；云平台下发数据格式也为16进制），
         其中数据处理方式为：
         
         a)去除10次传感数值的最高值和最低值，取其余数据的平均值；
         
         b)若上传的传感数值高于设定阈值，则警告指示灯亮起（传感器对应阈值及警告指示灯关系见表2），并在触摸屏上打印警告信息；

4、图形界面：移植触摸屏驱动至程序中并实现以下功能：

    （1）显示该设备DevEui。

    （2）显示本次上报数据内容。
    
    （3）显示本次通信状态（成功/失败）。

    （4）显示本次通信接收到的下行数据。

## 进阶设计实现功能

触摸屏新增参数修改界面，支持通过触摸屏修改参数，传感器类型修改后，采集的传感数值也要相应改变，参数修改界面和通信显示界面为两个界面，支持界面切换。可支持修改的参数：

    （1）定时上报时间、（2）每次上报采样的次数、（3）传感器类型。
    
## 表1  数据通信协议

| 字节序号 | 功能 |
| ------ | ------ |
| 字节1 | 上行帧帧头，固定值, 0xAA |
| 字节2 | 设备ID前两位（设备ID为DevEui最后4位） |
| 字节3 | 设备ID后两位（设备ID为DevEui最后4位） |
| 字节4 | 传感器类型 |
| 字节5 | 传感数据上报计数值，从0开始，随上报次数递增1，溢出时回到0重新计数。 |
| 字节6 | 传感数据整数部分（大于255部分） |
| 字节7 | 传感器整数部分（0~255） |
| 字节8 | 传感数据小数部分（取2位） |
| 字节9 | 帧尾，固定值：0x0F |
 
## 表2  传感器对应阈值及警告指示灯
| 字节编码 | 传感器类型 | 传感器阈值 | 警告指示灯 |
| ------ | ------ | ------ | ------ |
| 0x01 | 光照传感器 | 300Lux | D6 |
| 0x02 | 气压传感器 | 101kPa | D7 |
| 0x03 | 温度传感器 | 30℃ | D8 |
| 0x04 | 湿度传感器 | 60% | D11 |
			
